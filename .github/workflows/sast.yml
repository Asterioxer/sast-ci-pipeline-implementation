name: Reusable SAST Scan

on:
  workflow_call:
    inputs:
      source_path:
        description: "Path to the source code to scan"
        required: false
        default: "."
        type: string
    secrets:
      SAST_TOKEN:
        required: true

jobs:
  sast-scan:
    name: Run SAST Scan
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the consuming repository code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}

      # Step 2: Set up Python (required for Semgrep)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # Step 3: Install Semgrep
      - name: Install SAST tool (Semgrep)
        run: |
          pip install semgrep

      # Step 4: Run SAST scan (do NOT fail yet)
      - name: Run SAST scan
        continue-on-error: true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SAST_TOKEN }}
        run: |
          semgrep scan \
            --config=p/ci \
            --json \
            ${{ inputs.source_path }} > sast-results.json || true


      # Step 5: Enforce organization-wide SAST policy
      - name: Enforce SAST policy
        run: |
          findings=$(jq '.results | length' sast-results.json)

          echo "Total SAST findings detected: $findings"

          if [ "$findings" -gt 0 ]; then
            echo "❌ SAST findings detected. Failing the build."
            exit 1
          else
            echo "✅ No SAST findings detected. Build can proceed."
          fi
